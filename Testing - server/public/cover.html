<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Theme Made By www.w3schools.com - No Copyright -->
  <title>Bootstrap Theme Simply Me</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <style>
  body {
    font: 20px Montserrat, sans-serif;
    line-height: 1.8;
    color: #f5f6f7;
  }
  p {font-size: 16px;}
  .margin {margin-bottom: 45px;}
  .bg-nav{
    background-color: #2f4858; /* primary */
    color: #3aa1dd;
  }
  .bg-prim {
    background-color: #2f4858; /* primary */
    color: #ffffff;
  }
  .bg-accent {
    background-color: #3aa1dd; /* accent */
    color: #ffffff;
  }

  .container-fluid {
    padding-top: 70px;
    padding-bottom: 70px;
  }
  .navbar {
    padding-top: 15px;
    padding-bottom: 15px;
    border: 0;
    border-radius: 0;
    margin-bottom: 0;
    font-size: 12px;
    letter-spacing: 5px;
  }
  .navbar-nav  li a:hover {
    color: #1abc9c !important;
  }
  /*style the box*/
         .gm-style .gm-style-iw {
            background-color: #252525 !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            min-height: 120px !important;
            padding-top: 10px;
            display: block !important;
         }

         /*style the p tag*/
         .gm-style .gm-style-iw #google-popup p{
            padding: 10px;
         }


        /*style the arrow*/
        .gm-style div div div div div div div div {
            background-color: #252525 !important;
            padding: 0;
            margin: 0;
            padding: 0;
            top: 0;
            color: #fff;
            font-size: 16px;
        }
</style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-defaul bg-prim">
    <div class="container">
      <div class="navbar-header bg-pnav" >
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <div class = "row">
          <img src="VierveLogo.png" class="img-rounded" width="100" height="90" >
          <a  href="#">Vierve</a>
        </div>

      </div>
      <div class="collapse navbar-collapse bg-prim" id="myNavbar">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#">WHO</a></li>
          <li><a href="#">WHAT</a></li>
          <li><a href="#">WHERE</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- First Container -->
  <div class="container-fluid bg-prim text-center">
    <div id="map" class="z-depth-1" style="height: 500px"></div>
  </div>


  
  <script>
  var api_key = "AIzaSyCW2WCj-4vyZTrNqWp6qVK1sDGx6UaviJo"

  var style = [
  {
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#212121"
      }
    ]
  },
  {
    "elementType": "labels.icon",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "color": "#212121"
      }
    ]
  },
  {
    "featureType": "administrative",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "featureType": "administrative.country",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#9e9e9e"
      }
    ]
  },
  {
    "featureType": "administrative.locality",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#bdbdbd"
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "featureType": "poi.business",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#181818"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "labels.text",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#616161"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "color": "#1b1b1b"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "geometry.fill",
    "stylers": [
      {
        "color": "#2c2c2c"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#8a8a8a"
      }
    ]
  },
  {
    "featureType": "road.arterial",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#373737"
      }
    ]
  },
  {
    "featureType": "road.highway",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#3c3c3c"
      }
    ]
  },
  {
    "featureType": "road.highway.controlled_access",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#4e4e4e"
      }
    ]
  },
  {
    "featureType": "road.local",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#616161"
      }
    ]
  },
  {
    "featureType": "transit",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#000000"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#3d3d3d"
      }
    ]
  }
]

  var timePerEx = 7500

  var directionsService
  var map;
  var current ;
  var polylines = []
  var message

  var college_data = {};
  var parking_data = {};

  var propData = []
  var index = 0;
  var responses = [];

  function initMap(){
    loadCollegeData(
      function(){
        loadPropData(
          function(){
            directionsService = new google.maps.DirectionsService()
            var directionsDisplay = new google.maps.DirectionsRenderer()
            var mapOptions = {
              zoom: 14,
              styles:style
            }
            map = new google.maps.Map(document.getElementById('map'),mapOptions);
            directionsDisplay.setMap(map);
            startCycle(timePerEx)
          }
        )
      }
    )

  }

  function loadPropData(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "http://localhost:3000/getPropData", true);
    xhr.send();
    xhr.onreadystatechange = processRequest;
    function processRequest(e) {
      if (xhr.readyState == 4 && xhr.status == 200) {

        var response = JSON.parse(xhr.responseText);
        for(i = 0; i <= response.ids.length ; i++){
          if(i == response.ids.length){

            callback()
          }
          else{

            var id = response.ids[i]
            var obj = response.data[id]

            propData.push({
              origin:{lat:obj.parker_lat,lng:obj.parker_lng},
              des:{lat:parkinglot_data[obj.parkinglot_id.toString()]['coor_lat'],lng:parkinglot_data[obj.parkinglot_id.toString()]['coor_lng']},
              waypoints:[{location:{lat:obj.pu_lat,lng:obj.pu_lng},stopover:true}],
              time_saved:obj.time_saved
            })
          }

        }

      }
    }
  }

  function loadCollegeData(callback){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "http://localhost:3000/data", true);
    xhr.send();
    xhr.onreadystatechange = processRequest;
    function processRequest(e) {
      if (xhr.readyState == 4 && xhr.status == 200) {
        var response = JSON.parse(xhr.responseText);
        if(response.code == 2){
          college_data = response.cd;
          parkinglot_data = response.pd;
          callback()
        }

      }
    }
  }

  function startCycle(time){
    calcRoute(0,propData[0].origin,propData[0].des,propData[0].waypoints,propData[0].time_saved)
    setInterval(function(){
      index++
      calcRoute(index,propData[index].origin,propData[index].des,propData[index].waypoints,propData[index].time_saved)
      if(index == propData.length-1){
        index = 0
      }


    },time)
  }

  function calcRoute(index,origin,des,waypoints,ts) {
    var directionsDisplay = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      suppressInfoWindows: false
    });
    directionsDisplay.setMap(map);


    var request = {
      origin: origin,
      destination: des,
      waypoints: waypoints,
      travelMode:google.maps.TravelMode.DRIVING
    }
    if(responses[index] == undefined){
      directionsService.route(request, function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          responses[index] = response
          //directionsDisplay.setDirections(response);
          if(current != null){
            current = null
            fadeOut(polylines,1000,function(){
              customDirectionsRenderer(origin, des, response,ts);
            })
          }
          else{
            customDirectionsRenderer(origin, des, response,ts);
          }
        }
      });
    }
    else{

      fadeOut(polylines,1000,function(){
        customDirectionsRenderer(origin, des, responses[index],ts);
      })
    }

  }



  function customDirectionsRenderer(origin , des, response,ts) {
    polylines = []
    var polylineLength = 0
    var bounds = new google.maps.LatLngBounds();
    var legs = response.routes[0].legs;
    for (i = 0; i < legs.length; i++) {
      current = new google.maps.Polyline({
        map: map,
        strokeColor: "#3aa1dd",
        path: [],
        strokeOpacity:0

      })

      polylines.push(current)
      if (i%2 == 1 ) {
        current.setOptions({
          strokeColor: "#2f4858"

        });
      }

      var steps = legs[i].steps;
      for (j = 0; j < steps.length; j++) {
        var nextSegment = steps[j].path;
        for (k = 0; k < nextSegment.length; k++) {
          current.getPath().push(nextSegment[k]);
          bounds.extend(nextSegment[k]);
        }
      }
      polylineLength += google.maps.geometry.spherical.computeLength(current.getPath().getArray())
    }




    current.setMap(map)
    map.fitBounds(bounds);
    fadeIn(polylines,1000,function(){

      message = null
      message = new google.maps.InfoWindow({
        content: "<div class=\"bg-prim\">Distance Saved: "+Math.round(polylineLength * 100) / 100+" meters <br> Time Saved : "+ts+" minutes"});
        message.open(map)
        message.setPosition(origin);

      })



    }


    function fadeIn(line, fadeDuration,callback){
      var parts = 100;
      var targetOpacity = 0.0,
      startTime = (new Date()).getTime();
      function step(){
        targetOpacity = targetOpacity + (1/parts);
        for(i = 0; i < line.length; i++){
          line[i].setOptions({
            strokeOpacity: targetOpacity
          });
        }
        if(targetOpacity <=1){
          setTimeout(step,fadeDuration/parts)
        }
        else{
          callback()
        }
      }
      step()
    }

    function fadeOut(line, fadeDuration,callback){
      message.close()
      var parts = 100;
      var targetOpacity = 1.0,
      startTime = (new Date()).getTime();

      function step(){
        targetOpacity = targetOpacity - (1/parts);

        for(i = 0; i < line.length; i++){
          line[i].setOptions({
            strokeOpacity: targetOpacity
          });
        }
        if(targetOpacity >0){
          setTimeout(step,fadeDuration/parts)
        }
        else{
          for(i = 0; i < polylines.length; i++){
            polylines[i].setMap(null)
          }
          callback()
        }
      }
      step()
    }

    google.maps.event.addListener(infowindow, 'domready', function() {

   var iwOuter = $('.gm-style-iw');

   var iwBackground = iwOuter.prev();

   iwBackground.children(':nth-child(2)').css({
     'background': '#252525'
   });

   var iwmain = iwBackground.children(':nth-child(2)');

   iwBackground.children(':nth-child(4)').css({
     'display': 'none'
   });

   var iwCloseBtn = iwOuter.next();

 });



  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCW2WCj-4vyZTrNqWp6qVK1sDGx6UaviJo&callback=initMap"
  async defer></script>

</body>
</html>
