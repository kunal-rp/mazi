<!DOCTYPE html>
<html>
<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
  /* Always set the map height explicitly to define the size of the div
  * element that contains the map. */
  #map {
    height: 80%;
  }
  /* Optional: Makes the sample page fill the window. */
  html, body {
    height: 80%;
    margin: 0;
    padding: 0;
  }
  </style>
</head>
<body>

  <button onclick="calcRoute({lat:34.057112000,lng:-117.8165950000},{lat:parkinglot_data['2001']['coor_lat'],lng:parkinglot_data['2001']['coor_lng']},[{location:{lat:34.058134000,lng:-117.8264490000},stopover:true}],'blue')">Route 1</button>
  <button onclick="calcRoute({lat:34.050450000,lng:-117.818698000},{lat:parkinglot_data['2006']['coor_lat'],lng:parkinglot_data['2006']['coor_lng']},[{location:{lat:34.059539000,lng:-117.82401500},stopover:true}],'red')">Route 2</button>

  <div id="map"/>
  <script>
  var api_key = "AIzaSyCW2WCj-4vyZTrNqWp6qVK1sDGx6UaviJo"


  var directionsService
  var map;
  var current ;
  var polylines = []

  var college_data = {};
  var parking_data = {};

  function initMap(){
    loadData(function(){
      directionsService = new google.maps.DirectionsService()
      var directionsDisplay = new google.maps.DirectionsRenderer()
      var mapOptions = {
        zoom: 14,
        center: {lat:college_data['100010']['college_coor_lat'] , lng: college_data['100010']['college_coor_lng']}
      }
      map = new google.maps.Map(document.getElementById('map'),mapOptions);
      directionsDisplay.setMap(map);

    })

  }

  function loadData(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "http://localhost:3000/data", true);
    xhr.send();

    xhr.onreadystatechange = processRequest;
    function processRequest(e) {
      if (xhr.readyState == 4 && xhr.status == 200) {
        var response = JSON.parse(xhr.responseText);
        if(response.code == 2){
          college_data = response.cd;
          parkinglot_data = response.pd;
          console.log(parkinglot_data)
          callback()
        }

      }
    }
  }

  function calcRoute(origin,des,waypoints,color) {
    var directionsDisplay = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      suppressInfoWindows: false
    });
    directionsDisplay.setMap(map);


    var request = {
      origin: origin,
      destination: des,
      waypoints:waypoints,
      travelMode:google.maps.TravelMode.DRIVING
    }
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        //directionsDisplay.setDirections(response);
        if(current != null){
          current = null
          fadeOut(polylines,1000,function(){
            for(i = 0; i < polylines.length; i++){
              polylines[i].setMap(null)
            }
            polylines = []
            customDirectionsRenderer(response);

          })
        }
        else{
          customDirectionsRenderer(response);
        }

      }
    });
  }

  function customDirectionsRenderer(response) {
    var bounds = new google.maps.LatLngBounds();
    var legs = response.routes[0].legs;
    for (i = 0; i < legs.length; i++) {
      current = new google.maps.Polyline({
        map: map,
        strokeColor: "#3aa1dd",
        path: [],
        strokeOpacity:0,
        tag:"The Beginning"

      })
      polylines.push(current)
      if (i%2 == 1 ) {
        current.setOptions({
          strokeColor: "#2f4858",
          tag:"the end"
        });
      }

      var steps = legs[i].steps;
      for (j = 0; j < steps.length; j++) {
        var nextSegment = steps[j].path;
        for (k = 0; k < nextSegment.length; k++) {
          current.getPath().push(nextSegment[k]);
          bounds.extend(nextSegment[k]);
        }
      }
    }
    current.setMap(map)
    map.fitBounds(bounds);
    fadeIn(polylines,1000,function(){ })

  }


  function fadeIn(line, fadeDuration,callback){
      var targetOpacity = 0.0,
      startTime = (new Date()).getTime();
      function step(){
        targetOpacity = targetOpacity + .1;

        for(i = 0; i < line.length; i++){
          line[i].setOptions({
            strokeOpacity: targetOpacity
          });
        }
        if(targetOpacity <1.1){
          setTimeout(step,fadeDuration/10)
        }
        else{
          callback()
        }
      }
      step()
  }

  function fadeOut(line, fadeDuration,callback){
      var targetOpacity = 1.0,
      startTime = (new Date()).getTime();
      function step(){
        targetOpacity = targetOpacity - .1;
        
        for(i = 0; i < line.length; i++){
          line[i].setOptions({
            strokeOpacity: targetOpacity
          });
        }
        if(targetOpacity >0){
          setTimeout(step,fadeDuration/10)
        }
        else{
          callback()
        }
      }
      step()
  }

  function getDirections(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "https://maps.googleapis.com/maps/api/directions/json?origin=Disneyland&destination=Universal+Studios+Hollywood4&key="+api_key, true);
    xhr.send();
    xhr.onreadystatechange = processRequest;
    function processRequest(e) {
      if (xhr.readyState == 4 && xhr.status == 200) {
        var response = JSON.parse(xhr.responseText);
        console.log(response)
      }
    }
  }

  //https://maps.googleapis.com/maps/api/directions/json?origin=Disneyland&destination=Universal+Studios+Hollywood4&key=


  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCW2WCj-4vyZTrNqWp6qVK1sDGx6UaviJo&callback=initMap"
  async defer></script>
</body>
</html>
